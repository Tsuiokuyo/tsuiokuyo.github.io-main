---
title: 轉貼©基於MHN開源項目的樹莓派蜜罐節點部署實戰
tags:
  - 轉貼
  - 樹莓派
  - 電腦安全
categories: 轉貼
preview_text: 轉貼文
abbrlink: fa6e
date: 2019-01-09 10:00:00
preview:
---



找尋原因：樹莓派目前積灰中，不過要玩這個的話還要弄一台linux有點麻煩，目前我的介面是windows 10，要設蜜罐則需要中心伺服器，所以除了樹莓派，還需要另外架設一台Ubuntu主機，雖然WIN10支援Windows *Subsystem* for Linux，不過本人已經在樹莓派做白工很多次了......，所以就單純留下紀錄，說不定以後會想玩。

而MHN原名為Modern Honey Network
https://github.com/threatstream/mhn

下面文章本人已簡單繁化。



----------

# 基於MHN開源項目的樹莓派蜜罐節點部署實戰

Posted on [2017年7月11日](https://sosly.me/index.php/2017/07/11/mhndionaea/)

{% asset_img 0.jpg %}

*本文曾於2015年11月發表在Freebuf，修正後更新到自己的新部落格。需要說明的是，本文使用的MHN開源項目的中心伺服器在安裝配置時需要連接一些國外的服務，如果安裝時出現類似提示通常是服務連接不上。因此建議購買境外VPS部署，或在配置伺服器時能夠通過代理訪問到相關的服務。如果是單純地想玩一下蜜罐，可以在虛擬機或者樹莓派上部署擁有獨立Web界面的Dionaea蜜罐進行嘗試。*

*樓主表示：最開始是玩樹莓派，然後接觸了蜜罐，後面和幾個小伙伴還真的做了一個基於樹莓派的攜帶型蜜罐的項目，並由此寫了研究生的畢業論文，以後再敘。*

**本文測試的內容是在已搭建好MHN中心伺服器的前提下，嘗試用樹莓派搭建Dionaea 蜜罐 ，部署在區域網路內，即時檢測區域網路內部攻擊，同時透過出口路由器埠映射的方式，實現外網攻擊的即時檢測和攻擊地圖展示。主要是討論一下這種MHN蜜罐網路的特點，以及蜜罐節點搭建過程中的問題解決：包括蜜罐第一次部署遇到的常見問題及解決辦法，蜜罐的快速批次部署的思路（即插即用），蜜罐穩定性問題及解決方法，蜜罐節點的訂製等。**

## 0x00 MHN簡介

MHN簡介：

> MHN是一個開源軟體，它簡化了蜜罐的部署，同時便於收集和統計蜜罐的數據。用ThreatStream（<http://threatstream.github.io/mhn/>）來部署，MHN使用開源蜜罐來收集數據，整理後保存在Mongodb中，收集到的訊息也可以透過web介面來展示或者通過開發的API訪問。
> MHN能夠提供多種開源的蜜罐，可以透過web介面來添加他們。一個蜜罐的部署過程很簡單，只需要黏貼，複製一些命令就可以完成部署，部署完成後，可以透過開源的協議hpfeeds來收集的訊息。

採用MHN中心伺服器和樹莓派蜜罐終端的方式主要考慮如下幾點
\1. MHN中心伺服器可部署在獨立ip的遠程VPS上，部署簡單，支持多種蜜罐
\2. 樹莓派蜜罐終端成本低，部署也比較容易，部署好後可以即插即用
\3. MHN中心伺服器匯總數據，展示；使得蜜罐終端可以靈活部署在內外網，只要網路能連接到MHN中心伺服器即可

搭建好後，訪問3000埠，就會看到預設的世界地圖準備就緒（沒有數據來源的情況下空白狀態）：
{% asset_img 1.jpg %}

首先看MHN中心伺服器支持的蜜罐終端的類型（還是很豐富）:
{% asset_img 2.png %}

這裡我們選擇比較簡單的“Raspberry Pi-Dionaea”，就是樹莓派上的Dionaea蜜罐，Dionaea是個低交互蜜罐。
Dionaea簡介：

> Dionaea(捕蠅草) 低互動式蜜罐是 Honeynet Project 的開源項目，起始於 Google Summer of Code 2009，是Nepenthes(豬籠草)項目的後繼。Honeynet Project 是成立於 1999 年的國際性非盈利研究組織，致力於提高網路的安全性，在蜜罐技術與網際網路安全威脅研究領域具有較大的影響力。
> Dionaea 蜜罐的設計目的是誘捕惡意攻擊，獲取惡意攻擊會話與惡意代碼程式樣本。它通過模擬各種常見服務，捕獲對服務的攻擊數據，記錄攻擊源和目標IP、埠、協議類型等訊息，以及完整的網路會話過程，自動分析其中可能包含的 shellcode 及其中的函數調用和下載文件，並獲取惡意程式。
> 有別於高互動式蜜罐採用真實系統與服務誘捕惡意攻擊，Dionaea 被設計成低互動式蜜罐，它為攻擊者展示的所有攻擊弱點和攻擊對象都不是真正的產品系統，而是對各種系統及其提供的服務的模擬。這樣設計的好處是安裝和配置十分簡單，蜜罐系統幾乎沒有安全風險，不足之處是不完善的模擬會降低數據捕獲的能力，並容易被攻擊者識別。

為什麼用樹莓派呢？
樹莓派，沒玩過的可以簡單理解為一個微型計算機主機。
百度百科:[樹莓派](http://baike.baidu.com/link?url=6sDixIpkBXPAm9Zz7ZjEYDHI5oP3SYtdNkAfZOb_QuZ5RqC3C0EiRx-EQaLEyf0uLpoXkcmM3k7luHUWWW1bfFKLQGusvJWA9dOYo7zMnxe)
為什麼選用樹莓派作為終端呢？
\1. 這兩年樹莓派軟硬體發展，社區建設也比較迅速，學習和使用比較便捷
\2. 成本低：一個樹莓派主體 + 電源 + SD卡不超過300元。
\3. 便攜，樹莓派很小，搭建好之後便於攜帶，即插即用。配合移動電源還可以實現短時間獨立供電。

## 0x01 樹莓派搭建Dionaea蜜罐實戰

本地搭建蜜罐終端前提：MHN已在遠程VPS搭建好且運行正常 （其實蜜罐終端也可獨立部署，然後通過訪問查看捕獲到的攻擊數據和攻擊地圖展示，這裡說的不是這種模式）
那麼開始搭建樹莓派蜜罐吧，讓地圖閃動起來~

樹莓派部署Dionaea參考教學（放輕鬆，姿勢正常的話會很順利）：
<https://github.com/threatstream/mhn/wiki/Deploying-Dionaea-on-a-Raspberry-Pi>
為了少出錯誤，基本按照官方教學來。

**工具和軟體準備**

在Windows7下進行工具的下載和樹莓派SD卡的處理（這次用的是一個16GB的SD卡，用讀卡器連接到電腦上）
用到的工具（前兩個）
{% asset_img 3.png %}

工具下載連結：
[SDFromatter](https://www.sdcard.org/downloads/formatter_4/)
[NOOBS_lite](http://downloads.raspberrypi.org/NOOBS_lite/images/)
用“SDFromatter”軟體格式化SD卡，直接用Windows格式化應該也可以，注意一下磁碟格式，考慮到後面樹莓派裝的linux系統。
把“NOOBS_lite”下載，解壓後如下圖，整個拷貝到SD卡中。
{% asset_img 4.png %}

**樹莓派聯網安裝所需操作系統**

然後準備工作就做好了，可以把SD卡插到樹莓派中，給樹莓派連接上網線（保證樹莓派能夠穩定上網就行），啟動，就進入安裝界面，按照教學一步步操作就好了。
注意：這個安裝其實是安裝的操作系統，邊下載邊安裝，很慢，我安裝的時候，整整等了12個小時才安好...（安裝的是Debian GNU/Linux system）
{% asset_img 5.png %}
{% asset_img 6.png %}

然後就可以重啟進入樹莓派系統了。

**幾個建議做的樹莓派初始化設置：**
**首次啟動的設置，用戶及密碼設置**
首次啟動將出現系統初始配置的界面，這個界面在也可以在之後的終端視窗中通過`sudo raspi-config`
啟動選擇2 Change User Password ，改一下pi用戶的密碼，初始密碼為空或者raspberry。
root用戶默認沒開啟，重新開啟root帳號，可由pi用戶登錄後，在命令行下執行
`sudo passwd root`
執行此命令後系統會提示輸入兩遍的root密碼，輸入你想設的密碼即可，然後在執行
`sudo passwd --unlock root`
這樣就可以解鎖root帳戶了。

**讓樹莓派支持中文**
終端中輸入（通常需要root權限）：
`sudo apt-get install ttf-wqy-zenhei`
將安裝文泉驛的開源中文字體
輸入法呢？ Linux 下早就有，叫 SCIM （ Smart Common Input Method ），輸入：
`sudo apt-get install scim-pinyin`

**時間設置**
部署的MHN的中心伺服器在國外，預設是是格林威治時間（世界時間）：
Greenwich Mean Time(GMT): 10/22/2015 08:52:41 Thursday(星期四)
想把樹莓派設置成國內的本地時間，
使用時區設置，`sudo dpkg-reconfigure tzdata`
試了幾種，最後選擇time zone“Asia/Chita” 就對了

**網路設置**
默認設置是DHCP，根據需要修改，可改成靜態ip。
設置樹莓派為靜態ip的方法和debian linux修改是一樣的 ，
只需要修改文件`sudo vi /etc/network/interfaces`文件即可。

**開啟SSH服務**
終端裡，`sudo raspi-config` 。選項8
8-4-ssh enable 。打開ssh服務。
遠程連接putty和winscp，直接root登錄預設是禁止的。
putty的ssh可以，普通用戶接入，然後su，改成root用戶。

**在樹莓派上安裝和部署Dionaea蜜罐，和中心伺服器進行連接**
前提是樹莓派已經接入了區域網路，為了方便，可以在電腦上SSH連接樹莓派，root權限下通過執行命令安裝Dionaea。
首先Web登錄遠程的MHN中心伺服器：
{% asset_img 7.png %}

複製這條命令執行即可，
`wget "http://MHN伺服器的ip/api/script/?text=true&script_id=10" -O deploy.sh && sudo bash deploy.sh http://MHN伺服器的ip d5xofICf`

等幾分鐘，蜜罐就部署好了，中心伺服器就能看到這個節點了。
{% asset_img 8.png %}

以後只要把這個樹莓派通電，連上網就可以自動工作了。服務會開機自啟動的。

**幾個需要解決的問題：**
**部署在區域網路的蜜罐如何檢測外網攻擊?**
部署在區域網路內的樹莓派蜜罐，只能檢測到內網的掃描行為，你會發現那個攻擊地圖什麼也沒有，而且通常情況下，一般的單位被攻擊到內網的情況比較少。想部署在外網呢？很多人又沒這個條件，成本也高。
所以，如果你的外網是ADSL或者電信寬頻，有獨立外網IP的話，可以透過在出口路由器設置埠映射的方式。
{% asset_img 9.png %}

埠映射出去，會給內網帶來一定的風險。但是Dionaea 被設計成低互動式蜜罐，它為攻擊者展示的所有攻擊弱點和攻擊對象都不是真正的產品系統，而是對各種系統及其提供的服務的模擬，網路配置適當的話，風險還是比較小的。
這樣就能夠檢測外網攻擊了。

**如何快速批次地部署多個終端?**
上述，安裝操作系統的時候需要聯網等待12個小時，還是太久了。所以，推薦的解決辦法，是對一個安裝好操作系統，基本配置完成的樹莓派的SD卡進行鏡像複製成img文件。然後就可以方便地還原到新的SD卡中，還原後只需要執行最後一步安裝蜜罐的那條命令就好了。
試了幾種方法，各有利弊，但是推薦一種傻瓜式的方法，windows下使用win32diskimager軟體複製，或者linux下使用dd命令複製效果是一樣的。
但需要注意的是：這個複製是全盤複製，意思是說，我這次安裝的時候用的是16GB的SD卡，雖然安裝好後實際只用了4GB多，但是複製後的img文件足足有14GB多，這樣的話，拿一個小於等於16GB的SD卡來進行還原，往往就會因為空間不足還原不了。
所以，強烈建議首次安裝的時候用小於等於8GB的SD卡，然後複製成img鏡像，以後批次部署，就可以方便地把這個img鏡像，還原到16GB大小的SD卡上直接使用了。（其實就複製4GB的方法也有，要麻煩些）

嘗試“win32diskimager-binary.rar”工具：
注意：為了避免奇葩的錯誤，請使用英文路徑，且路徑不要有空格。
先自己先建立一個後綴為img的文件，例如miguan.img，要不然之後操作時會提示文件不存在。
然後以管理員身份運行這個程式，必要時關閉防毒軟體。
{% asset_img 10.png %}

選中這個空的文件，然後用read命令，製作鏡像。
{% asset_img 11.png %}
{% asset_img 12.png %}

**樹莓派Dionaea 蜜罐終端的穩定性問題?**
試運行幾天後，我發現這個樹莓派Dionaea 蜜罐終端運行幾天後就捕捉不到攻擊行為了，重啟後就可以馬上恢復正常。或者是樹莓派蜜罐突然斷網，網路恢復後有時也會出現捕獲不到攻擊了。一個解決思路就是定時重啟。這樣可以持續穩定運行。說起來容易，折騰了一晚上才解決。
給出最簡單的解決方法：
借助crontab定時任務，設定每天8點執行，比較常見的就是，echo命令可以很順利執行，結果reboot命令，怎麼都不執行。權限問題。
試了很久，各種姿勢。
最後發現，想要執行重啟，在root用戶下，必須把命令寫到 `/etc/crontab` 文件中，而且格式必須對，只要報錯就說明命令格式不對。
`00 08 * * * root reboot` 這個命令就可以正常執行了 每天8點重啟

nano編輯器也不錯
{% asset_img 13.png %}

Ctrl + X 退出,然後Y保存
改動後
`service cron restart` 重啟服務
然後
`service cron status` 不報錯，就ok了

cron命令詳解：
<https://www.raspberrypi.org/documentation/linux/usage/cron.md>

## 0x02 實驗效果

部署在區域網路的樹莓派，一副撲克牌大小：
{% asset_img 14.jpg %}

攻擊地圖一夜裡收到的攻擊：
{% asset_img 15.jpg %}
{% asset_img 16.jpg %}

說明：紅圈圈說明剛檢測到的攻擊源，紅點表示之前捕捉到的攻擊源。底下會顯示時間，攻擊源所在地，經緯度。
看到我一個普通寬頻的ip每天都被那麼多人掃描，還是有種感知的即視感。
登錄後可看到攻擊細節：IP、時間、掃描的埠、包類型等。
{% asset_img 17.jpg %}
{% asset_img 18.jpg %}

攻擊細節記錄（大都是被掃描記錄）
低互動式蜜罐的普遍弱點：

> 即對網路服務的模擬與真實服務存在差距，可能無法捕獲某些對環境敏感的攻擊，可以搭配其他專用服務蜜罐一起使用，來不斷進行完善。

## 0x03 應用場景思考

**檢測潛在的內網攻擊**
單位各區域網路中部署一台，管理員定期查看，捕捉內網攻擊。
也可通過埠映射，檢測潛在的外網攻擊。
**蜜罐的深度利用**
及時看到潛在攻擊行為，提前應對；學習攻擊者針對該服務的攻擊技巧和利用代碼。 一些蜜罐能夠捕獲惡意軟體，利用代碼等等。
再次提醒：蜜罐是把雙刃劍，如果不能正確的使用，有可能遭受更多的攻擊，模擬服務的軟體存在問題，也會產生新的漏洞。
**MHN中心伺服器的訂製開發**
蜜罐終端傳回的畢竟是基礎數據，可以通過自己開發程式對基礎數據進行處理和分析，提取出關注的訊息，增加報警功能等。也可以把攻擊地圖改了，比如<http://map.norsecorp.com/>
{% asset_img 19.png %}

## 0x04 繼續

**如果看到這裡你心動了，就去嘗試用樹莓派配置蜜罐節點吧。**

**主要參考文章匯總：**
<http://cb.drops.wiki/drops/papers-5968.html> （蜜罐網路）
<http://cb.drops.wiki/drops/tips-640.html> （Dionaea低互動式蜜罐部署詳解）
<https://github.com/threatstream/mhn/wiki/Deploying-Dionaea-on-a-Raspberry-Pi>（樹莓派部署Dionaea參考教學）

------

*轉載請註明出處 ：sosly 菜鳥筆記*
<https://sosly.me/index.php/2017/07/11/mhndionaea/>



此文章轉載自：[sosly 菜鸟笔记](https://sosly.me/index.php/2017/07/11/mhndionaea/)